---
title: "Veeraraghavan et al 2017"
author: "James D. Brenton"
date: "18 March 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

```{r, echo=FALSE}
require(tidyverse)
require(knitr)
require(broom)
require(survival)
require(survminer)
# options for output
options(scipen=1, digits=2)
# Variants of mean, median etc with na.rm = T
min_    <- function(...) min(..., na.rm=T)
max_    <- function(...) max(..., na.rm=T)
mean_   <- function(...) mean(..., na.rm=T)
median_ <- function(...) median(..., na.rm=T)
Q1_     <- function(...) quantile(..., probs=0.25, na.rm = TRUE)
Q3_     <- function(...) quantile(..., probs=0.75, na.rm = TRUE)
sum_    <- function(...) sum(..., na.rm=T)
# function to return counts of samples
n_fun <- function(x, y){ # y is position for labels
  return(data.frame(y, label = paste0("n = ", length(x))))
}
```

Load in clinical data.

```{r, echo = FALSE}
clin.data <- read_csv("2017-Veeraraghavan-data.csv")
```

## Simple data exploration

Total number of patients

```{r patients_total, echo = FALSE}
clin.data %>%
  distinct(tcga.id) %>% tally()
```

Are there any duplicate tcga.id?

```{r, echo = FALSE}
clin.data %>%
  select(tcga.id) %>% tally()
```

How many in each group?

```{r, echo = FALSE}
clin.data %>%
    group_by(institution.bin) %>%
  summarise(n = n()) %>%
  mutate(rel.freq = n/sum(n))
#  kable(digits = 2)
```
What was follow up? (NO DATA IN DATA FILE)


How many platinum sensitive vs. resistant?

```{r, echo = FALSE}
clin.data %>%
  group_by(institution.bin, platinum.resistant) %>%
  summarise(n = n()) %>%
  mutate(rel.freq = n/sum(n))
```
Were there stage differences?

```{r, echo = FALSE}
clin.data %>%
  group_by(institution.bin, stage) %>%
  summarise(n = n()) %>%
  mutate(rel.freq = n/sum(n))
```

Were there differences in tumour volume between the cohorts?

```{r, echo = FALSE}
clin.data %>%
    group_by(institution.bin) %>%
    summarize_each(funs(
    min_,
    Q1_,
    median_,
    Q3_,
    max_
    ), 
    volume.cc) 
```

Plot the volume distributions.

```{r, echo = FALSE}
clin.data %>%
  ggplot(aes(x = institution.bin, y = volume.cc)) + geom_boxplot() +
    stat_summary(fun.data = n_fun, fun.args = 3000, geom = "text")
```

Non-parametric test for volume distributions.

```{r, echo = FALSE}
clin.data %>% 
  do(tidy(wilcox.test(volume.cc ~ institution.bin, data = .)))
```

Were there differences in the number of sites (ROI) between the cohorts?

```{r, echo = FALSE}
clin.data %>%
    group_by(institution.bin) %>%
    summarize_each(funs(
    min_,
    Q1_,
    median_,
    Q3_,
    max_
    ), 
    sites) 
```

Plot the ROI counts.

```{r, echo = FALSE}
clin.data %>%
  ggplot(aes(x = institution.bin, y = sites)) + geom_boxplot() +
    stat_summary(fun.data = n_fun, fun.args = 15, geom = "text")
```

Non-parametric test for ROI.

```{r, echo = FALSE}
clin.data %>% 
  do(tidy(wilcox.test(sites ~ institution.bin, data = .)))
```

## Survival analysis

What is OS in the two cohorts?


```{r, echo=FALSE}
clin.data %>% 
  group_by(institution.bin) %>% 
  do(glance(survfit(Surv(time=os.mos, event=dead=="1") ~ 1, data=.)))
```

Plot comparison of OS.

```{r, echo=FALSE}
ggsurvplot(
  survfit(Surv(time=os.mos, event=dead=="1") ~ institution.bin, data=clin.data),
  data = clin.data, risk.table = TRUE, conf.int = TRUE)
```

What is PFS in the two cohorts?

```{r, echo=FALSE}
clin.data %>% 
  group_by(institution.bin) %>% 
  do(glance(survfit(Surv(time=pfs.mos, event=recurrence=="1") ~ 1, data=.)))
```
Plot comparison of PFS. The data for TCIA is has wide confidence intervals and is probably not usable.

```{r, echo=FALSE}
ggsurvplot(
  survfit(Surv(time=pfs.mos, event=recurrence=="1") ~ institution.bin, data=clin.data),
  data = clin.data, risk.table = TRUE, conf.int = TRUE)
```

What are main factors for OS from Cox proportional hazard analysis?

```{r, echo=FALSE}
clin.data %>% 
  # filter(stage > 2) %>% # 4 stage 2 cases in the TCIA cohort
  group_by(institution.bin) %>%
  do(tidy(
    coxph(Surv(time=os.mos, event=dead=="1")
          ~ age + stage + platinum.resistant + volume.cc + residual.disease,
          data=.),
    exponentiate = TRUE)) %>%
  select(institution.bin, term, estimate, p.value, conf.low, conf.high) %>%
  arrange(institution.bin, p.value)
```

What are main factors for PFS from Cox proportional hazard analysis?


```{r, echo=FALSE}
clin.data %>% 
  #filter(stage > 2) %>% # 4 stage 2 cases in the TCIA cohort
  group_by(institution.bin) %>%
  do(tidy(
    coxph(Surv(time=pfs.mos, event=recurrence=="1")
          ~ age + stage + platinum.resistant + volume.cc + residual.disease,
          data=.),
    exponentiate = TRUE)) %>%
  select(institution.bin, term, estimate, p.value, conf.low, conf.high) %>%
  arrange(institution.bin, p.value)
```       
